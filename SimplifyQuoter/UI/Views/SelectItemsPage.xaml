<UserControl x:Class="SimplifyQuoter.Views.SelectItemsPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Height="Auto" Width="Auto">

    <!-- ===== Resources (팔레트/스타일 먼저 선언) ===== -->
    <UserControl.Resources>
        <!-- Palette -->
        <SolidColorBrush x:Key="WindowBackgroundBrush" Color="#F6F7FB"/>
        <SolidColorBrush x:Key="CardBackgroundBrush"   Color="#FFFFFFFF"/>
        <SolidColorBrush x:Key="SurfaceBrush"          Color="#FFF2F4F8"/>
        <SolidColorBrush x:Key="AccentBrush"           Color="#4F46E5"/>
        <SolidColorBrush x:Key="AccentBrushLight"      Color="#E8E7FF"/>
        <SolidColorBrush x:Key="TextPrimaryBrush"      Color="#111827"/>
        <SolidColorBrush x:Key="TextSecondaryBrush"    Color="#6B7280"/>
        <SolidColorBrush x:Key="BorderBrushSoft"       Color="#E5E7EB"/>

        <CornerRadius x:Key="InputRadius">8</CornerRadius>

        <!-- Buttons -->
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="{StaticResource AccentBrush}"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderBrush" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="10">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="2"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#5F56F0"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#4038CF"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.45"/>
                                <Setter Property="Cursor" Value="Arrow"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="GhostButton" TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
            <Setter Property="Foreground" Value="{StaticResource AccentBrush}"/>
            <Setter Property="Background" Value="{StaticResource AccentBrushLight}"/>
        </Style>

        <!-- Inputs -->
        <Style x:Key="ModernTextBox" TargetType="TextBox">
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
            <Setter Property="Background" Value="{StaticResource SurfaceBrush}"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrushSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="{StaticResource InputRadius}">
                            <ScrollViewer x:Name="PART_ContentHost" Margin="0"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                                <Setter TargetName="Bd" Property="Background"  Value="White"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ModernComboBox" TargetType="ComboBox">
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
            <Setter Property="Background" Value="{StaticResource SurfaceBrush}"/>
            <Setter Property="Padding" Value="6,2"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrushSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <Border x:Name="Bd"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="{StaticResource InputRadius}"/>
                            <DockPanel Margin="6,0">
                                <ContentPresenter Margin="0,4,24,4" VerticalAlignment="Center" RecognizesAccessKey="True"/>
                                <Path DockPanel.Dock="Right" VerticalAlignment="Center"
                                      Data="M 0 0 L 8 0 L 4 5 Z" Width="10" Height="6"
                                      Fill="{StaticResource TextSecondaryBrush}"/>
                            </DockPanel>
                            <Popup Name="PART_Popup" Placement="Bottom"
                                   IsOpen="{TemplateBinding IsDropDownOpen}"
                                   AllowsTransparency="True" Focusable="False"
                                   PopupAnimation="Slide">
                                <Border Background="White" CornerRadius="10"
                                        BorderBrush="{StaticResource BorderBrushSoft}" BorderThickness="1" Padding="4">
                                    <ScrollViewer CanContentScroll="True" MaxHeight="240">
                                        <ItemsPresenter/>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocusWithin" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                                <Setter TargetName="Bd" Property="Background"  Value="White"/>
                            </Trigger>
                            <Trigger Property="HasItems" Value="False">
                                <Setter Property="MinHeight" Value="32"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Setter Property="ItemContainerStyle">
                <Setter.Value>
                    <Style TargetType="ComboBoxItem">
                        <Setter Property="Padding" Value="8,6"/>
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ComboBoxItem">
                                    <Border x:Name="row" CornerRadius="6" Background="Transparent" Padding="6,2">
                                        <ContentPresenter/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="row" Property="Background" Value="#F1F5FF"/>
                                        </Trigger>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="row" Property="Background" Value="{StaticResource AccentBrushLight}"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Toggle-like CheckBox -->
        <Style x:Key="SwitchCheckBox" TargetType="CheckBox">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <Grid>
                            <Grid Width="44" Height="24" Cursor="Hand">
                                <Border x:Name="Track" Background="#E5E7EB" CornerRadius="12"/>
                                <Border x:Name="Thumb" Width="20" Height="20" Background="White" CornerRadius="10" Margin="2">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="8" ShadowDepth="1" Opacity="0.25"/>
                                    </Border.Effect>
                                </Border>
                            </Grid>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Track" Property="Background" Value="{StaticResource AccentBrush}"/>
                                <Setter TargetName="Thumb" Property="Margin" Value="22,2,2,2"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- DataGrid (안전 스타일: Template 미수정) -->
        <Style x:Key="PreviewDataGrid" TargetType="DataGrid">
            <Setter Property="Background" Value="{StaticResource CardBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrushSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="RowHeight" Value="32"/>
            <Setter Property="AlternatingRowBackground" Value="#FAFAFE"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="EnableRowVirtualization" Value="True"/>
            <Setter Property="ScrollViewer.CanContentScroll" Value="True"/>
            <Setter Property="VirtualizingPanel.IsVirtualizing" Value="True"/>
            <Setter Property="VirtualizingPanel.VirtualizationMode" Value="Recycling"/>
            <Setter Property="ColumnHeaderStyle">
                <Setter.Value>
                    <Style TargetType="DataGridColumnHeader">
                        <Setter Property="Background" Value="{StaticResource SurfaceBrush}"/>
                        <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                        <Setter Property="FontWeight" Value="SemiBold"/>
                        <Setter Property="BorderBrush" Value="{StaticResource BorderBrushSoft}"/>
                        <Setter Property="BorderThickness" Value="0,0,0,1"/>
                        <Setter Property="Padding" Value="10,6"/>
                        <Setter Property="HorizontalContentAlignment" Value="Left"/>
                    </Style>
                </Setter.Value>
            </Setter>
            <Setter Property="CellStyle">
                <Setter.Value>
                    <Style TargetType="DataGridCell">
                        <Setter Property="BorderThickness" Value="0"/>
                        <Setter Property="Padding" Value="8,0"/>
                        <Style.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="#EEF2FF"/>
                                <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="TextBlock">
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
        </Style>
    </UserControl.Resources>

    <!-- 배경은 Grid에 지정 (StaticResource 안전) -->
    <Grid Margin="20" Background="{StaticResource WindowBackgroundBrush}">
        <!-- ===== 원래 3행×2열 레이아웃 복원 ===== -->
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Row 0: 안내 -->
            <RowDefinition Height="Auto"/>
            <!-- Row 1: 입력 -->
            <RowDefinition Height="*"/>
            <!-- Row 2: 선택 목록 -->
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <!-- Col 0: 좌측 패널 -->
            <ColumnDefinition Width="*"/>
            <!-- Col 1: Excel 프리뷰 -->
        </Grid.ColumnDefinitions>

        <!-- Row 0, Col 0: 안내 텍스트 -->
        <TextBlock Grid.Row="0" Grid.Column="0"
                   Text="You can type ranges or select directly from the sheet. All will be combined."
                   FontWeight="Bold" TextWrapping="Wrap" Margin="0,0,16,12"/>

        <!-- Row 0→2, Col 1: Excel Preview (원본과 동일) -->
        <DataGrid x:Name="DataGridAllRows"
                  Grid.Row="0"
                  Grid.RowSpan="3"
                  Grid.Column="1"
                  AutoGenerateColumns="False"
                  SelectionMode="Extended"
                  SelectionUnit="FullRow"
                  SelectedCellsChanged="DataGridAllRows_SelectedCellsChanged"
                  GridLinesVisibility="All"
                  HeadersVisibility="Column"
                  Margin="0"
                  Style="{StaticResource PreviewDataGrid}"
                  ScrollViewer.VerticalScrollBarVisibility="Auto"
                  ScrollViewer.HorizontalScrollBarVisibility="Auto"/>

        <!-- Row 1, Col 0: 입력 -->
        <StackPanel Grid.Row="1" Grid.Column="0" Orientation="Vertical" Margin="0,0,16,12">
            <!-- Range -->
            <StackPanel Orientation="Horizontal" Margin="0,0,0,12" VerticalAlignment="Center">
                <TextBlock Text="Range:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                <Border Background="#EEE" CornerRadius="4" Padding="4,2" VerticalAlignment="Center">
                    <TextBox x:Name="TxtRange"
                             Width="140"
                             Background="Transparent"
                             BorderThickness="0"
                             FontSize="14"
                             VerticalContentAlignment="Center"
                             Text="4-8, 11, 56-90"
                             Foreground="Gray"
                             GotFocus="TxtRange_GotFocus"
                             LostFocus="TxtRange_LostFocus"
                             ToolTip="e.g. 4-8, 11, 56-90"/>
                </Border>
                <Button Content="Apply" Click="BtnApplyRange_Click" Margin="13,0,8,0" Padding="8,4" VerticalAlignment="Center" Style="{StaticResource PrimaryButton}" Width="57"/>
                <Button x:Name="BtnNext" Content="Next" Width="51" Margin="0,0,10,0" Click="BtnNext_Click" Style="{StaticResource GhostButton}"/>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0,0,0">
                    <CheckBox x:Name="ChkSkipAI"
                              Style="{StaticResource SwitchCheckBox}"
                              Checked="ChkSkipAI_Checked"
                              Unchecked="ChkSkipAI_Unchecked" RenderTransformOrigin="0.784,0.483"/>
                    <TextBlock Text="Skip AI (No GPT)" Margin="8,0,0,0" VerticalAlignment="Center" Foreground="{StaticResource TextSecondaryBrush}"/>
                </StackPanel>
            </StackPanel>

            <!-- Margin & UoM -->
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="Margin %" VerticalAlignment="Center" Margin="0,0,12,0"/>
                <Border Background="#EEE" CornerRadius="4" Padding="4,2" VerticalAlignment="Center">
                    <TextBox x:Name="TxtMargin"
                             Width="60"
                             Background="Transparent"
                             BorderThickness="0"
                             FontSize="14"
                             Text="20"
                             VerticalContentAlignment="Center"
                             ToolTip="Enter margin as a percentage (e.g. 20)"/>
                </Border>
                <Rectangle Width="24" Fill="Transparent"/>
                <TextBlock Text="UoM" VerticalAlignment="Center" Margin="0,0,12,0"/>
                <Border Background="#EEE" CornerRadius="4" Padding="4,2" VerticalAlignment="Center">
                    <ComboBox x:Name="CmbUoM"
                              Width="100"
                              Background="Transparent"
                              BorderThickness="0"
                              IsEditable="True"
                              FontSize="14"
                              VerticalContentAlignment="Center"
                              Style="{StaticResource ModernComboBox}">
                        <ComboBoxItem Content="EACH"/>
                        <ComboBoxItem Content="PACK"/>
                    </ComboBox>
                </Border>
            </StackPanel>
        </StackPanel>

        <!-- Row 2, Col 0: Selected Items -->
        <GroupBox Header="Selected Items" Grid.Row="2" Grid.Column="0" Padding="4" Margin="0,0,136,0" Width="300">
            <DataGrid x:Name="DataGridSelected"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      IsReadOnly="True"
                      HeadersVisibility="Column"
                      GridLinesVisibility="All"
                      Style="{StaticResource PreviewDataGrid}"/>
        </GroupBox>

    </Grid>
</UserControl>
